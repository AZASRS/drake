---
title: "drake"
subtitle: "beginner example"
author: "Will Landau and Kirill MÃ¼ller"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{drake}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = F}
suppressMessages(suppressWarnings(library(drake)))
suppressMessages(suppressWarnings(library(tidyverse)))
unlink(".drake", recursive = TRUE)
clean(destroy = TRUE, verbose = FALSE)
unlink(c("Makefile", "report.Rmd", "shell.sh", "STDIN.o*", "Thumbs.db"))
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = TRUE
)
pkgconfig::set_config("drake::strings_in_dots" = "literals")
dat <- system.file(
  file.path("examples", "beginner", "raw_data.xlsx"),
  package = "drake",
  mustWork = TRUE
)
tmp <- file.copy(from = dat, to = "raw_data.xlsx")
rmd <- system.file(
  file.path("examples", "beginner", "report.Rmd"),
  package = "drake",
  mustWork = TRUE
)
tmp <- file.copy(from = rmd, to = "report.Rmd")
```

A typical data analysis workflow is a sequence of data transformations. Raw data becomes tidy data, which then turns into fitted models, summaries, and reports.

<img src="https://ropensci.github.io/drake/images/tidydag.png" alt="tidydag" align="center" style = "border: none; float: center;">

# Plan your work.

To get started with `drake`, you need to plan out these data transformations.

```{r pitchplan}
plan <- drake_plan(
  raw_data = readxl::read_excel(file_in("raw_data.xlsx")),
  data = raw_data %>%
    mutate(Species = forcats::fct_inorder(Species)),
  hist = create_plot(data),
  fit = lm(Sepal.Width ~ Petal.Width + Species, data),
  knitr::knit(
    knitr_in("report.Rmd"),
    output = file_out("report.md"),
    quiet = TRUE
  )
)
plan
```

The commands usually reference supporting functions and packages. Simply load them into your R session.

```{r pitchfunctions}
library(drake)
library(tidyverse)
create_plot <- function(data) {
  ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram()
}
```

Our workflow is now ready to run, but it is usually a good idea to check the dependency graph first.

```{r pitchgraph1, eval = FALSE}
config <- drake_config(plan)
vis_drake_graph(config)
```

<iframe
src = "https://ropensci.github.io/drake/images/pitch1.html"
width = "100%" height = "600px" allowtransparency="true"
style="border: none; box-shadow: none">
</iframe>

The `make()` function actually does the work. The targets build in the correct order regardless of the order of the rows in your plan.

```{r pitchmake1}
make(plan)
```

The file `report.md` was written, and everything else was stored in a hidden `.drake/` folder. Inspect the intermediate data objects using `loadd()` and `readd()`.

```{r pitchreadd}
summary(readd(fit))
```

```{r pitchloadd}
loadd(data, hist)
data
```

# Go back and change things.

Whether your code takes minutes, hours, or days to run, it is almost never quite right the first time. **You will want to go back and change things. A lot.** For example, our data has a superfluous `X__1` column. Let's change the plan to remove it.

```{r pitchx1}
plan <- drake_plan(
  raw_data = readxl::read_excel(file_in("raw_data.xlsx")),
  data = raw_data %>%
    mutate(Species = forcats::fct_inorder(Species)) %>%
    select(-X__1),
  hist = create_plot(data),
  fit = lm(Sepal.Width ~ Petal.Width + Species, data),
  rmarkdown::render(
    knitr_in("report.Rmd"),
    output_file = file_out("report.md"),
    quiet = TRUE
  )
)
```

The changed command affects `data` and everything depending on it. Those targets are now out of date.

```{r pitchgraph2, eval = FALSE}
vis_drake_graph(config)
```

<iframe
src = "https://ropensci.github.io/drake/images/pitch2.html"
width = "100%" height = "600px" allowtransparency="true"
style="border: none; box-shadow: none">
</iframe>

The next `make()` just builds the outdated targets and leaves `raw_data` alone.

```{r pitchmake2}
make(plan)

readd(data)

readd(hist)
```

Oops, we forgot to pick a bin width for our histogram. Let's fix our plot function.

```{r fixplot}
create_plot <- function(data) {
  ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram(binwidth = 0.25) +
    theme_gray(20)
}
```

Only the histogram and the report need to change.

```{r pitchgraph3, eval = FALSE}
vis_drake_graph(config)
```

<iframe
src = "https://ropensci.github.io/drake/images/pitch3.html"
width = "100%" height = "600px" allowtransparency="true"
style="border: none; box-shadow: none">
</iframe>

The next `make()` skips all the data wrangling and model fitting steps.

```{r histmake}
make(plan)
```

Want to try out the code yourself? Use `drake_example("beginner")` to write the files.

```{r endofline_pitch, echo = FALSE}
clean(destroy = TRUE, verbose = FALSE)
unlink(c("report.Rmd", "raw_data.xlsx", "STDIN.o*", "Thumbs.db"))
```
