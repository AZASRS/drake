---
title: "drake"
subtitle: "beginner example"
author: "Will Landau and Kirill MÃ¼ller"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{drake}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = F}
suppressMessages(suppressWarnings(library(drake)))
suppressMessages(suppressWarnings(library(tidyverse)))
unlink(".drake", recursive = TRUE)
clean(destroy = TRUE, verbose = FALSE)
unlink(c("Makefile", "report.Rmd", "shell.sh", "STDIN.o*", "Thumbs.db"))
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = TRUE
)
pkgconfig::set_config("drake::strings_in_dots" = "literals")
write_csv(iris, "raw_data.xlsx")
rmd <- system.file(
  file.path(
    "rmarkdown", "templates", "drake", "skeleton", "skeleton.Rmd"
  ),
  package = "drake",
  mustWork = TRUE
)
file.copy(from = rmd, to = "report.Rmd")
invisible()
```

A typical data analysis workflow is a sequence of data transformations.

<img src="https://ropensci.github.io/drake/images/tidydag.png" alt="tidydag" align="center" style = "border: none; float: center;">

In `drake`, you declare all the transformations in a data frame of targets and commands. The `drake_plan()` function creates the workflow plan data frame but does not run it.

```{r pitchplan}
plan <- drake_plan(
  raw_data = readxl::read_excel(file_in("raw_data.xlsx")),
  data = raw_data %>%
    mutate(Species = forcats::fct_inorder(Species)),
  hist = create_plot(data),
  fit = lm(Sepal.Width ~ Petal.Width + Species, data),
  knitr::knit(
    knitr_in("report.Rmd"),
    output = file_out("report.md"),
    quiet = TRUE
  )
)
plan
```

Plans usually reference supporting functions and packages. Simply load them into your R session.

```{r pitchfunctions}
library(drake)
library(tidyverse)
create_plot <- function(data) {
  ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram()
}
```

The network graph visualizes the dependencies among the files, functions, targets, and other intermediate data objects. The dependency relationships depend on how the objects are referenced, not on the order of the rows in the workflow plan data frame.

```{r pitchgraph1, eval = FALSE}
config <- drake_config(plan)
vis_drake_graph(config)
```

<iframe
src = "https://ropensci.github.io/drake/images/pitch1.html"
width = "100%" height = "600px" allowtransparency="true"
style="border: none; box-shadow: none">
</iframe>

Use the `make()` function to actually run the workflow.

```{r pitchmake1}
make(plan)
```

Inspect the generated `report.md` file.

```{r pitchmd}
cat(head(readLines("report.md")), sep = "\n")
```

Inspect the intermediate data objects using `loadd()` and `readd()`.

```{r pitchreadd}
summary(readd(fit))
```

```{r pitchloadd}
loadd(data, hist)
data
```

At this point, we notice an unwanted `X__1` column in the data. Let's change the plan to remove it.

```{r pitchx1}
plan <- drake_plan(
  raw_data = readxl::read_excel(file_in("raw_data.xlsx")),
  data = raw_data %>%
    mutate(Species = forcats::fct_inorder(Species)) %>%
    select(-X__1),
  hist = create_plot(data),
  fit = lm(Sepal.Width ~ Petal.Width + Species, data),
  rmarkdown::render(
    knitr_in("report.Rmd"),
    output_file = file_out("report.md"),
    quiet = TRUE
  )
)
```

The changed command affects `data` and everything depending on it. Those targets are now out of date.

```{r pitchgraph2, eval = FALSE}
vis_drake_graph(config)
```

<iframe
src = "https://ropensci.github.io/drake/images/pitch2.html"
width = "100%" height = "600px" allowtransparency="true"
style="border: none; box-shadow: none">
</iframe>

The next `make()` just builds the outdated targets and leaves `raw_data` alone.

```{r pitchmake2}
make(plan)

readd(data)
```

Skipping targets saves time when we repeatedly go back and change things. For example, we forgot to select a bin width for our histogram.

```{r readdhist2}
readd(hist)
```

Let's fix our plot function.

```{r fixplot}
create_plot <- function(data) {
  ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram(binwidth = 0.25) +
    theme_gray(20)
}
```

Only the histogram and the report need to change.

```{r pitchgraph3}
vis_drake_graph(config)
```

<iframe
src = "https://ropensci.github.io/drake/images/pitch3.html"
width = "100%" height = "600px" allowtransparency="true"
style="border: none; box-shadow: none">
</iframe>

So the next `make()` skips all the data wrangling and model fitting.

```{r histmake}
make(plan)
```

```{r endofline_pitch, echo = FALSE}
clean(destroy = TRUE, verbose = FALSE)
unlink(c("report.Rmd", "raw_data.xlsx", "STDIN.o*", "Thumbs.db"))
```
