---
title: "drake"
subtitle: "where to begin"
author: "Will Landau"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{drake}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = F}
suppressMessages(suppressWarnings(library(drake)))
suppressMessages(suppressWarnings(library(tidyverse)))
unlink(".drake", recursive = TRUE)
clean(destroy = TRUE, verbose = FALSE)
unlink(c("Makefile", "report.Rmd", "shell.sh", "STDIN.o*", "Thumbs.db"))
knitr::opts_chunk$set(
  collapse = TRUE,
  error = TRUE,
  warning = TRUE
)
readr::write_csv(iris, "raw-data.csv")
pkgconfig::set_config("drake::strings_in_dots" = "literals")
```

According to [Tidyverse](https://www.tidyverse.org/) wisdom, a typical project is a sequence of data transformations: importing, tidying, on up through communicating.

<img src="https://ropensci.github.io/drake/images/tidydag.png" alt="infographic" align="center" style = "border: none; float: center;">

Lay out these transformations with a workflow plan data frame. The `drake_plan()` function creates the plan but does not run anything.

```{r pitchplan}
plan <- drake_plan(
  raw_data = readxl::read_csv(file_in("raw-data.csv")),
  data = raw_data %>%
    mutate(Species = forcats::fct_inorder(Species)),
  hist = create_plot(data),
  fit = lm(Sepal.Width ~ Petal.Width + Species, data),
  rmarkdown::render(
    knitr_in("report.Rmd"),
    output_file = file_out("report.md"),
    quiet = TRUE
  )
)
plan
```

Plans usually need supporting functions and packages from you. Load them.

```{r pitchfunctions}
library(drake)
library(tidyverse)
create_plot <- function(data) {
  ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram()
}
```

The dependency graph visualizes the data transformations. The steps are in the correct order regardless of the row order of the plan.

```{r pitchgraph1}
config <- drake_config(plan)
vis_drake_graph(
  config, from = file_store("raw-data.csv"), mode = "out",
  build_times = "none", ncol_legend = 0, width = "100%"
)
```

Use the `make()` function to actually run the workflow.

```{r pitchmake1}
make(plan)
```

Inspect the generated `report.md` file.

```{r pitchmd}
cat(readLines("report.md"))
```

Inspect the intermediate data objects using `loadd()` and `readd()`.

```{r pitchreadd}
summary(readd(fit))
```

```{r pitchloadd}
loadd(data, hist)
data
```

At this point, I notice an unwanted `X__1` column in the data. Let's change the plan to remove it.

```{r pitchx1}
plan <- drake_plan(
  raw_data = readxl::read_csv(file_in("raw-data.csv")),
  data = raw_data %>%
    mutate(Species = forcats::fct_inorder(Species)) %>%
    select(-X__1),
  hist = create_plot(data),
  fit = lm(Sepal.Width ~ Petal.Width + Species, data),
  rmarkdown::render(
    knitr_in("report.Rmd"),
    output_file = file_out("report.md"),
    quiet = TRUE
  )
)
```

The changed command affects `data` and everything depending on it is out of date.

```{r pitchgraph2}
config <- drake_config(plan)
vis_drake_graph(
  config, from = file_store("raw-data.csv"), mode = "out",
  build_times = "none", full_legend = FALSE, width = "100%"
)
```

But there is no reason to update `raw_data`.

```{r pitchmake2}
make(plan)

readd(data)
```

Skipping up-to-date targets saves time, and we will need those time savings when we go back and change things over and over again. For example, we forgot to select a bin width for our histogram.

```{r readdhist2}
readd(hist)
```

Let's fix our plot function.

```{r fixplot}
create_plot <- function(data) {
  ggplot(data, aes(x = Petal.Width, fill = Species)) +
    geom_histogram() +
    geom_histogram(binwidth = 0.25) +
    theme_gray(20)
}
```

Only the histogram and the report need to change.

```{r pitchgraph3}
vis_drake_graph(
  config,
  build_times = "none", full_legend = FALSE, width = "100%"
)
```

So the next `make()` skips the data processing/modeling.

```{r histmake}
make(plan)
```

```{r endofline_drake, echo = F}
clean(destroy = TRUE, verbose = FALSE)
unlink(c("Makefile", "report.Rmd", "shell.sh", "STDIN.o*", "Thumbs.db"))
```

