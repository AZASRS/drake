<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>High-performance computing with drake • drake</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">drake</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/drake.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/faq.html">FAQ</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example-packages.html">Example: R package download trends</a>
    </li>
    <li>
      <a href="../articles/example-gsp.html">Example: gross state products</a>
    </li>
    <li>
      <a href="../articles/example-mtcars.html">Example: mtcars and workflow plan generation</a>
    </li>
    <li>
      <a href="../articles/best-practices.html">General best practices for drake projects</a>
    </li>
    <li>
      <a href="../articles/debug.html">Debugging and testing drake projects</a>
    </li>
    <li>
      <a href="../articles/graph.html">Graphs with drake</a>
    </li>
    <li>
      <a href="../articles/parallelism.html">Parallel computing</a>
    </li>
    <li>
      <a href="../articles/timing.html">Time logging</a>
    </li>
    <li>
      <a href="../articles/storage.html">Storage</a>
    </li>
    <li>
      <a href="../articles/caution.html">Caution</a>
    </li>
    <li>
      <a href="../articles/faq.html">Frequently-asked questions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/drake">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>High-performance computing with drake</h1>
                        <h4 class="author">Will Landau</h4>
            
            <h4 class="date">2018-04-27</h4>
          </div>

    
    
<div class="contents">
<p><code>Drake</code> has extensive high-performance computing support, from local multicore parallelism to serious distributed computing across multiple nodes of a cluster. Control it with the <code>parallelism</code> and <code>jobs</code> arguments to <code><a href="../reference/make.html">make()</a></code>, and use <code><a href="http://www.rdocumentation.org/packages/future/topics/plan">future::plan()</a></code> if <code>parallelism</code> is <code>"future_lapply"</code>.</p>
<div id="the-concept" class="section level1">
<h1 class="hasAnchor">
<a href="#the-concept" class="anchor"></a>The concept</h1>
<p><code>Drake</code>’s approach to parallelism relies on the network graph representation of a project.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="../reference/clean.html">clean</a></span>()</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="../reference/load_mtcars_example.html">load_mtcars_example</a></span>()</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">config &lt;-<span class="st"> </span><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">jobs =</span> <span class="dv">2</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>) <span class="co"># Parallelize over 2 jobs.</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co"># Change a dependency.</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">reg2 &lt;-<span class="st"> </span><span class="cf">function</span>(d) {</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  d<span class="op">$</span>x3 &lt;-<span class="st"> </span>d<span class="op">$</span>x <span class="op">^</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  <span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x3, <span class="dt">data =</span> d)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co"># Hover, click, drag, zoom, and pan.</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="kw"><a href="../reference/vis_drake_graph.html">vis_drake_graph</a></span>(config, <span class="dt">width =</span> <span class="st">"100%"</span>, <span class="dt">height =</span> <span class="st">"500px"</span>)</a></code></pre></div>
<iframe src="https://ropensci.github.io/drake/images/reg2.html" width="100%" height="600px" allowtransparency="true" style="border: none; box-shadow: none">
</iframe>
<p>The nodes in each column above are conditionally independent given the dependencies to the left. So in general, the targets and imports are processed column by column from left to right, and everything within a column is executed in parallel. When some targets are already up to date, <code>drake</code> searches ahead in the graph to maximize the number of outdated targets in each parallelizable stage.</p>
<p>To show the parallelizable stages of the next <code><a href="../reference/make.html">make()</a></code> programmatically, use the <code><a href="../reference/parallel_stages.html">parallel_stages()</a></code> function. All the targets/imports in a stage are processed in parallel before moving on to the next stage.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="../reference/parallel_stages.html">parallel_stages</a></span>(config)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">##                      item imported  file stage</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">## 1            "report.Rmd"     TRUE  TRUE     1</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">## 2              data.frame     TRUE FALSE     1</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">## 3                    knit     TRUE FALSE     1</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">## 4                      lm     TRUE FALSE     1</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">## 5                  mtcars     TRUE FALSE     1</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">## 6                    nrow     TRUE FALSE     1</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">## 7              sample.int     TRUE FALSE     1</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">## 8                 summary     TRUE FALSE     1</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">## 9        suppressWarnings     TRUE FALSE     1</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">## 10            random_rows     TRUE FALSE     2</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">## 11                   reg1     TRUE FALSE     2</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">## 12                   reg2     TRUE FALSE     2</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">## 13               simulate     TRUE FALSE     3</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">## 14      regression2_large    FALSE FALSE     4</a>
<a class="sourceLine" id="cb2-17" data-line-number="17">## 15      regression2_small    FALSE FALSE     4</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">## 16 coef_regression2_large    FALSE FALSE     5</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">## 17 coef_regression2_small    FALSE FALSE     5</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">## 18 summ_regression2_large    FALSE FALSE     5</a>
<a class="sourceLine" id="cb2-21" data-line-number="21">## 19 summ_regression2_small    FALSE FALSE     5</a>
<a class="sourceLine" id="cb2-22" data-line-number="22">## 20            "report.md"    FALSE  TRUE     6</a></code></pre></div>
</div>
<div id="how-many-parallel-jobs-should-you-use" class="section level1">
<h1 class="hasAnchor">
<a href="#how-many-parallel-jobs-should-you-use" class="anchor"></a>How many parallel jobs should you use?</h1>
<div id="not-too-many" class="section level2">
<h2 class="hasAnchor">
<a href="#not-too-many" class="anchor"></a>Not too many!</h2>
<p>Be mindful of the maximum number of simultaneous parallel jobs you deploy. Consequences of greed and carelessness range from poor etiquette to system crashes. In most cases, the <code>jobs</code> argument to <code><a href="../reference/make.html">make()</a></code> sets the maximum number of simultaneous jobs, but it does not apply to the parallel execution of targets when <code>parallelism</code> is <code>"future_lapply"</code>. If you use <code>"future_lapply"</code> parallelism, please see the <code>workers</code> argument to most supporting functions passed to <code><a href="http://www.rdocumentation.org/packages/future/topics/plan">future::plan()</a></code> (for example, <code><a href="http://www.rdocumentation.org/packages/future/topics/plan">future::plan(multisession(workers = 2))</a></code>). Depending on the <a href="https://github.com/HenrikBengtsson/future">future</a> backend you select with <code><a href="http://www.rdocumentation.org/packages/future/topics/plan">future::plan()</a></code> or <code><a href="http://www.rdocumentation.org/packages/future/topics/plan">future::plan()</a></code>, you might also make use of one of the other environment variables listed in <code><a href="http://www.rdocumentation.org/packages/future/topics/future.options">?future::future.options</a></code>.</p>
</div>
<div id="drake-can-report-the-maximum-number-of-useful-simultaneous-jobs" class="section level2">
<h2 class="hasAnchor">
<a href="#drake-can-report-the-maximum-number-of-useful-simultaneous-jobs" class="anchor"></a>Drake can report the maximum number of useful simultaneous jobs</h2>
<p>The <code><a href="../reference/max_useful_jobs.html">max_useful_jobs()</a></code> function analyzes your project and recommends a maximum value for the <code>jobs</code> argument to the next <code><a href="../reference/make.html">make()</a></code> (or the <code>workers</code> argument to a backend function in <a href="https://github.com/HenrikBengtsson/future">future</a>). This number returned by <code><a href="../reference/max_useful_jobs.html">max_useful_jobs()</a></code> is only an upper bound, not necessarily the number of <code>jobs</code> you should choose.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span>(drake)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="../reference/load_mtcars_example.html">load_mtcars_example</a></span>()</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">config &lt;-<span class="st"> </span><span class="kw"><a href="../reference/drake_config.html">drake_config</a></span>(my_plan)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw"><a href="../reference/vis_drake_graph.html">vis_drake_graph</a></span>(config) <span class="co"># Set targets_only to TRUE for smaller graphs.</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config) <span class="co"># 8</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config, <span class="dt">imports =</span> <span class="st">"files"</span>) <span class="co"># 8</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config, <span class="dt">imports =</span> <span class="st">"all"</span>) <span class="co"># 8</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config, <span class="dt">imports =</span> <span class="st">"none"</span>) <span class="co"># 8</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">config &lt;-<span class="st"> </span><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">jobs =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw"><a href="../reference/vis_drake_graph.html">vis_drake_graph</a></span>(config)</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co"># Ignore the targets already built.</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config) <span class="co"># 1</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config, <span class="dt">imports =</span> <span class="st">"files"</span>) <span class="co"># 1</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config, <span class="dt">imports =</span> <span class="st">"all"</span>) <span class="co"># 8</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config, <span class="dt">imports =</span> <span class="st">"none"</span>) <span class="co"># 0</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co"># Change a function so some targets are now out of date.</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17">reg2 &lt;-<span class="st"> </span><span class="cf">function</span>(d){</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">  d<span class="op">$</span>x3 &lt;-<span class="st"> </span>d<span class="op">$</span>x <span class="op">^</span><span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19">  <span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x3, <span class="dt">data =</span> d)</a>
<a class="sourceLine" id="cb3-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="kw"><a href="../reference/vis_drake_graph.html">vis_drake_graph</a></span>(config)</a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config) <span class="co"># 4</span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config, <span class="dt">from_scratch =</span> <span class="ot">TRUE</span>) <span class="co"># 8</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config, <span class="dt">imports =</span> <span class="st">"files"</span>) <span class="co"># 4</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config, <span class="dt">imports =</span> <span class="st">"all"</span>) <span class="co"># 8</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="kw"><a href="../reference/max_useful_jobs.html">max_useful_jobs</a></span>(config, <span class="dt">imports =</span> <span class="st">"none"</span>) <span class="co"># 4</span></a></code></pre></div>
</div>
<div id="caveats" class="section level2">
<h2 class="hasAnchor">
<a href="#caveats" class="anchor"></a>Caveats</h2>
<p><code>Drake</code> claims that it can</p>
<ol style="list-style-type: decimal">
<li>Build and cache your targets in parallel (in stages).</li>
<li>Build and cache your targets in the correct order, finishing dependencies before starting targets that depend on them.</li>
<li>Deploy your targets to the parallel backend of your choice.</li>
</ol>
<p>However, the practical efficiency of the parallel computing functionality remains to be verified rigorously. Serious performance studies will be part of future work that has not yet been conducted at the time of writing. In addition, each project has its own best parallel computing set up, and the user needs to optimize it on a case-by-case basis. Some general considerations include the following.</p>
<ul>
<li>The high overhead high scalability of distributed computing versus the low overhead and low scalability of local multicore computing.</li>
<li>The high memory usage of local multicore computing, especially <code>"mclapply"</code> parallelism, as opposed to distributed computing, which can spread the memory demands over the available nodes on a cluster.</li>
<li>The marginal gains of increasing the number of jobs indefinitely, especially in the case of local multicore computing if the number of cores is low.</li>
</ul>
</div>
</div>
<div id="parallel-backends" class="section level1">
<h1 class="hasAnchor">
<a href="#parallel-backends" class="anchor"></a>Parallel backends</h1>
<p><code>Drake</code> has multiple parallel backends, i.e. separate mechanisms for achieving parallelism. Some are low-overhead and limited, others are high-overhead and scalable. Just set the <code>parallelism</code> argument of <code>Make</code> to choose a backend. The best choice usually depends on your project’s intended scale and stage of deployment.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="../reference/parallelism_choices.html">parallelism_choices</a></span>()</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">## [1] "mclapply"      "parLapply"     "future"        "future_lapply"</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">## [5] "Makefile"</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="kw"><a href="../reference/parallelism_choices.html">parallelism_choices</a></span>(<span class="dt">distributed_only =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">## [1] "future"        "future_lapply" "Makefile"</a></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">?parallelism_choices  <span class="co"># Read an explanation of each backend.</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="../reference/default_parallelism.html">default_parallelism</a></span>() <span class="co"># "parLapply" on Windows, "mclapply" everywhere else</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">## [1] "mclapply"</a></code></pre></div>
<div id="mclapply" class="section level2">
<h2 class="hasAnchor">
<a href="#mclapply" class="anchor"></a>mclapply</h2>
<p>The <code>mclapply</code> backend is powered by the <code>mclapply()</code> function from the <code>parallel</code> package, and it forks multiple processes on your local machine. It spins up quickly, but it lacks scalability, and it does not work on Windows. If you try to call <code><a href="../reference/make.html">make(.., parallelism = "mclapply", jobs = 2)</a></code> on a Windows machine, <code>drake</code> will warn you and then demote <code>jobs</code> to 1.</p>
</div>
<div id="parlapply" class="section level2">
<h2 class="hasAnchor">
<a href="#parlapply" class="anchor"></a>parLapply</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(.., <span class="dt">parallelism =</span> <span class="st">"mclapply"</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</a></code></pre></div>
<p>The <code>parLapply</code> backend is powered by the <code>parLapply()</code> function from the <code>parallel</code> package. Like the <code>mclapply</code> backend, <code>parLapply</code> only scales up to a handful of jobs on your local machine. <code>parLapply</code> parallelism works on all platforms, but it takes a few seconds to initialize during each <code><a href="../reference/make.html">make()</a></code>. If <code>jobs</code> is less than 2, <code><a href="../reference/make.html">make()</a></code> does not bother setting up a parallel socket cluster, opting instead for <code>lapply()</code> to reduce overhead. The default parallel backend is <code>parLapply</code> on Windows machines and <code>mclapply</code> everywhere else.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(.., <span class="dt">parallelism =</span> <span class="st">"parLapply"</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw"><a href="../reference/default_parallelism.html">default_parallelism</a></span>() <span class="co"># "parLapply" on Windows, "mclapply" everywhere else</span></a></code></pre></div>
</div>
<div id="future_lapply" class="section level2">
<h2 class="hasAnchor">
<a href="#future_lapply" class="anchor"></a>future_lapply</h2>
<p>The <code>future</code> package unlocks a wide array of powerful parallel backends. The idea is to set up a <code><a href="http://www.rdocumentation.org/packages/future/topics/plan">future::plan()</a></code> in advance and then call <code><a href="../reference/make.html">make(parallelism = "future_lapply")</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">library</span>(future)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>()</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">## sequential:</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">## - args: function (expr, envir = parent.frame(), substitute = TRUE, lazy = FALSE, seed = NULL, globals = TRUE, local = TRUE, earlySignal = FALSE, label = NULL, ...)</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">## - tweaked: FALSE</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">## - call: plan("default", .init = FALSE)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(multicore)</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>()</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">## multicore:</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">## - args: function (expr, envir = parent.frame(), substitute = TRUE, lazy = FALSE, seed = NULL, globals = TRUE, workers = availableCores(constraints = "multicore"), earlySignal = FALSE, label = NULL, ...)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">## - tweaked: FALSE</a>
<a class="sourceLine" id="cb8-13" data-line-number="13">## - call: future::plan(multicore)</a></code></pre></div>
<p><code><a href="../reference/make.html">make()</a></code> knows which <code><a href="http://www.rdocumentation.org/packages/future/topics/plan">future::plan()</a></code> you selected.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"future_lapply"</span>)</a></code></pre></div>
<p>The <code>multicore</code> plan is the analogue of <code>mclapply</code> parallelism, and the <code>multisession</code> plan is the analogue of <code>parLapply</code> parallelism.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/multisession">multisession</a></span>(<span class="dt">workers =</span> <span class="dv">4</span>)) <span class="co"># Use a max of 4 parallel jobs at a time. # nolint</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"future_lapply"</span>)</a></code></pre></div>
<p>You can even deploy to your own parallel socket clusters clusters. You can use <code><a href="http://www.rdocumentation.org/packages/future/topics/makeClusterPSOCK">future::makeClusterPSOCK()</a></code> rather than <code><a href="http://www.rdocumentation.org/packages/parallel/topics/makeCluster">parallel::makePSOCKcluster()</a></code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">cl &lt;-<span class="st"> </span>future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/makeClusterPSOCK">makeClusterPSOCK</a></span>(2L, <span class="dt">dryrun =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(cluster, <span class="dt">workers =</span> cl)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"future_lapply"</span>)</a></code></pre></div>
<p>This approach should allow you to deploy targets to a <a href="https://www.docker.com/what-container">Docker container</a>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">## Setup of Docker worker running rocker and r-base # nolint</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">## (requires installation of future package)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">cl &lt;-<span class="st"> </span>future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/makeClusterPSOCK">makeClusterPSOCK</a></span>(</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">  <span class="st">"localhost"</span>,</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">  ## Launch Rscript inside Docker container</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">  <span class="dt">rscript =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">    <span class="st">"docker"</span>, <span class="st">"run"</span>, <span class="st">"--net=host"</span>, <span class="st">"rocker/r-base"</span>,</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">    <span class="st">"Rscript"</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">  ),</a>
<a class="sourceLine" id="cb12-10" data-line-number="10">  ## Install drake</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">  <span class="dt">rscript_args =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">    <span class="st">"-e"</span>, <span class="kw">shQuote</span>(<span class="st">"install.packages('drake')"</span>)</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">  )</a>
<a class="sourceLine" id="cb12-14" data-line-number="14">)</a>
<a class="sourceLine" id="cb12-15" data-line-number="15">future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(cluster, <span class="dt">workers =</span> cl)</a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"future_lapply"</span>)</a></code></pre></div>
<p>The <a href="https://github.com/HenrikBengtsson/future.batchtools">future.batchtools</a> package unlocks <a href="https://github.com/HenrikBengtsson/future.batchtools#choosing-batchtools-backend">even more parallel computing functionality</a>, particularly for popular job schedulers such as <a href="https://slurm.schedmd.com/">SLURM</a>, <a href="http://www.adaptivecomputing.com/products/open-source/torque/">TORQUE</a>, and the <a href="https://supcom.hgc.jp/english/utili_info/manual/uge.html">Univa Grid Engine</a>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">library</span>(future.batchtools)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw"><a href="../reference/drake_batchtools_tmpl_file.html">drake_batchtools_tmpl_file</a></span>(<span class="st">"slurm"</span>) <span class="co"># Write batchtools.slurm.tmpl.</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  batchtools_slurm,</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">  <span class="dt">template =</span> <span class="st">"batchtools.slurm.tmpl"</span>,</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">  <span class="dt">workers =</span> <span class="dv">16</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"future_lapply"</span>)</a></code></pre></div>
<p>You can even nest parallelism strategies together. In the following example, targets are submitted as jobs on the Univa Grid engine, and then <code>future</code>-style multicore parallelism is applied to each target’s command individually.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="../reference/drake_batchtools_tmpl_file.html">drake_batchtools_tmpl_file</a></span>(<span class="st">"sge"</span>) <span class="co"># Write sge-simple.tmpl.</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">    <span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/tweak">tweak</a></span>(batchtools_sge, <span class="dt">template =</span> <span class="st">"sge-simple.tmpl"</span>),</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">    multiprocess</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  )</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"future_lapply"</span>)</a></code></pre></div>
<p>For parallelism on clusters and job schedulers, special <a href="https://github.com/mllg/batchtools">batchtools</a> <code>*.tmpl</code> configuration files are required, and the technique is described in the documentation of <a href="https://github.com/mllg/batchtools">batchtools</a>. It is your responsibility to configure these files for your job scheduler. You can find some examples on the <code>inst/templates</code> folders of the <a href="https://github.com/mllg/batchtools/tree/master/inst/templates">batchtools</a> and <a href="https://github.com/HenrikBengtsson/future.batchtools/tree/master/inst/templates">future.batchtools</a> GitHub repositories. <code>Drake</code> has some <a href="https://github.com/ropensci/drake/tree/master/inst/examples">built-in prepackaged example workflows</a> as well. See <code><a href="../reference/drake_examples.html">drake_examples()</a></code> to view your options, and then <code><a href="../reference/drake_example.html">drake_example()</a></code> to write the files for an example.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw"><a href="../reference/drake_example.html">drake_example</a></span>(<span class="st">"sge"</span>)   <span class="co"># Sun/Univa Grid Engine workflow and supporting files</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw"><a href="../reference/drake_example.html">drake_example</a></span>(<span class="st">"slurm"</span>) <span class="co"># SLURM workflow and supporting files</span></a></code></pre></div>
<p>To just write the <a href="https://github.com/mllg/batchtools">batchtools</a> <code>*.tmpl</code> for an example, use</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw"><a href="../reference/drake_batchtools_tmpl_file.html">drake_batchtools_tmpl_file</a></span>(<span class="st">"sge"</span>)   <span class="co"># Writes sge-simple.tmpl</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="kw"><a href="../reference/drake_batchtools_tmpl_file.html">drake_batchtools_tmpl_file</a></span>(<span class="st">"slurm"</span>) <span class="co"># Writes batchtools.slurm.tmpl</span></a></code></pre></div>
<p>Be sure to heed the previously-mentioned cautionary note about deploying too many jobs at once. In <code>"future_lapply"</code> parallelism, the <code>jobs</code> argument applies to the imports, but not the targets. Functions passed to <code><a href="http://www.rdocumentation.org/packages/future/topics/plan">future::plan()</a></code> such as <code>mulitisession()</code> and <code><a href="http://www.rdocumentation.org/packages/future.batchtools/topics/batchtools_template">batchtools_slurm()</a></code> usually have a <code>workers</code> arguments for this purpose. Depending on the <code>future</code> backend you select with <code><a href="http://www.rdocumentation.org/packages/future/topics/plan">future::plan()</a></code>, you might also make use of one of the other environment variables listed in <code><a href="http://www.rdocumentation.org/packages/future/topics/future.options">?future::future.options</a></code>.</p>
</div>
<div id="future" class="section level2">
<h2 class="hasAnchor">
<a href="#future" class="anchor"></a>future</h2>
<p>The <code>future</code> backend is experimental and needs more real-world testing. It is similar to <code>future_lapply</code> except that individual futures are launched and managed using a manual job scheduler. Jobs are submitted as soon as workers become available, which overcomes an inefficiency of the usual staged parallelism. And with the optional <code>evaluator</code> column of the workflow plan data frame, you can use different computing resources for different targets. (See the <code>evaluator</code> argument of <code><a href="http://www.rdocumentation.org/packages/future/topics/future">future()</a></code>.)</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">library</span>(future)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw">library</span>(drake)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="kw"><a href="../reference/load_mtcars_example.html">load_mtcars_example</a></span>()</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">remote &lt;-<span class="st"> </span>future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(multisession)</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">local &lt;-<span class="st"> </span>future<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/future/topics/plan">plan</a></span>(multicore)</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">evaluator &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co"># Make the targets with the multisession future backend...</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(<span class="kw">nrow</span>(my_plan))){</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">  evaluator &lt;-<span class="st"> </span><span class="kw">c</span>(evaluator, remote)</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb17-11" data-line-number="11"><span class="co"># ...except for the R Markdown report.</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12">evaluator[[<span class="dv">1</span>]] &lt;-<span class="st"> </span>local</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">my_plan<span class="op">$</span>evaluator &lt;-<span class="st"> </span>evaluator</a>
<a class="sourceLine" id="cb17-14" data-line-number="14"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"future"</span>, <span class="dt">jobs =</span> <span class="dv">8</span>)</a></code></pre></div>
<p>In addition, you can set the <code>caching</code> argument to control when the values of the targets are cached: <code>"worker"</code> for the individual workers (default) and <code>"master"</code> for the master process. If you let the workers do the caching, you can take advantage of parallelism when targets are stored. On the other hand, <code>"master"</code> is a better option if workers do not have cache access or you are using a custom cache that is not thread-safe (e.g. <code><a href="http://www.rdocumentation.org/packages/storr/topics/storr_dbi">storr::storr_dbi()</a></code>.</p>
</div>
<div id="makefile" class="section level2">
<h2 class="hasAnchor">
<a href="#makefile" class="anchor"></a>Makefile</h2>
<p><code>Makefile</code> parallelism uses proper <a href="https://www.gnu.org/software/make/">Makefiles</a> to distribute targets across different R sessions. Similarly to <code>future_lapply</code> parallelism, it is a mechanism for distributing targets at scale.</p>
<div id="basic-makefile-parallelism" class="section level3">
<h3 class="hasAnchor">
<a href="#basic-makefile-parallelism" class="anchor"></a>Basic Makefile parallelism</h3>
<p>Before running <code>Makefile</code> parallelism, Windows users need to download and install <a href="https://cran.r-project.org/bin/windows/Rtools/"><code>Rtools</code></a>. For everyone else, just make sure <a href="https://www.gnu.org/software/make/">Make</a> is installed. Then, in the next <code><a href="../reference/make.html">make()</a></code>, simply set the <code>parallelism</code> and <code>jobs</code> arguments as before.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">2</span>)</a></code></pre></div>
<p>You will see a <code>Makefile</code> written to your working directory. Do not run this <code>Makefile</code> separately from <code>drake</code>. It will not work correctly by itself because it depends on the transient dummy timestamp files created by <code><a href="../reference/make.html">make()</a></code>.</p>
<p><code>Makefile</code> parallelism has its own modes of flexibility. You can now use the <code>args</code> argument to send custom arguments to the <code>Makefile</code>. For example, you could use 4 parallel jobs for the imports and 6 parallel jobs for the targets.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">4</span>, <span class="dt">args =</span> <span class="st">"--jobs=6 --silent"</span>)</a></code></pre></div>
<p>The <code>args</code> also let you print out the <code>Makefile</code> without running it, which helps during troubleshooting.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">args =</span> <span class="kw">c</span>(<span class="st">"--touch"</span>, <span class="st">"--silent"</span>))</a></code></pre></div>
<p>In addition, you can use a program other than <a href="https://www.gnu.org/software/make/">GNU Make</a>, such as <code>lsmake</code>, to run the <code>Makefile</code>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">4</span>, <span class="dt">command =</span> <span class="st">"lsmake"</span>)</a></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw"><a href="../reference/default_Makefile_command.html">default_Makefile_command</a></span>()</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">## [1] "make"</a></code></pre></div>
<p>For finer control over the build process, use the <code>recipe_command</code> argument. By default, the <code>recipe_command</code> is <code>"Rscript -e 'R_RECIPE'"</code>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="../reference/default_recipe_command.html">default_recipe_command</a></span>()</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">## [1] "Rscript -e 'R_RECIPE'"</a>
<a class="sourceLine" id="cb23-3" data-line-number="3"></a>
<a class="sourceLine" id="cb23-4" data-line-number="4"><span class="kw"><a href="../reference/r_recipe_wildcard.html">r_recipe_wildcard</a></span>()</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">## [1] "R_RECIPE"</a></code></pre></div>
<p>The <code>R_RECIPE</code> wildcard is replaced by <code><a href="http://www.rdocumentation.org/packages/drake/topics/mk">drake::mk("your_target", "path_to_cache")</a></code> in the <code>Makefile</code>. That way, a target named <code>your_target</code> is built with the <code>Makefile</code> recipe,</p>
<pre><code>Rscript -e 'drake::mk("your_target", "path_to_cache")'
</code></pre>
<p>You can change the recipe with the <code>recipe_command</code> argument to <code><a href="../reference/make.html">make()</a></code>. For example, to save some time and skip the loading of the <code>methods</code> package, you might use <code>"R -e 'R_RECIPE' -q"</code>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">  <span class="dt">recipe_command =</span> <span class="st">"R -e 'R_RECIPE' -q"</span>)</a></code></pre></div>
<p>The <code>Makefile</code> recipe for <code>your_target</code> becomes</p>
<pre><code>R -e 'drake::mk("your_target", "path_to_cache") -q'
</code></pre>
<p>But be warned: that particular recipe fails on Windows.</p>
<p>Use the <code><a href="../reference/Makefile_recipe.html">Makefile_recipe()</a></code> function to show and tweak <code>Makefile</code> recipes in advance.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw"><a href="../reference/Makefile_recipe.html">Makefile_recipe</a></span>(<span class="dt">cache_path =</span> <span class="st">"just_use_the_default"</span>)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">## Rscript -e 'drake::mk(target = "your_target", cache_path = "just_use_the_default")'</a>
<a class="sourceLine" id="cb25-3" data-line-number="3"></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="kw"><a href="../reference/Makefile_recipe.html">Makefile_recipe</a></span>(</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">  <span class="dt">recipe_command =</span> <span class="st">"R -e 'R_RECIPE' -q"</span>,</a>
<a class="sourceLine" id="cb25-6" data-line-number="6">  <span class="dt">target =</span> <span class="st">"this_target"</span>,</a>
<a class="sourceLine" id="cb25-7" data-line-number="7">  <span class="dt">cache_path =</span> <span class="st">"custom_cache"</span></a>
<a class="sourceLine" id="cb25-8" data-line-number="8">)</a>
<a class="sourceLine" id="cb25-9" data-line-number="9">## R -e 'drake::mk(target = "this_target", cache_path = "custom_cache")' -q</a></code></pre></div>
<p>If <code>recipe_command</code> contains no mention of <code>R_RECIPE</code>, then <code>R_RECIPE</code> is single-quoted and appended automatically.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw"><a href="../reference/Makefile_recipe.html">Makefile_recipe</a></span>(<span class="dt">recipe_command =</span> <span class="st">"R -q -e"</span>, <span class="dt">cache_path =</span> <span class="st">"supplied_by_default"</span>)</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">## R -q -e 'drake::mk(target = "your_target", cache_path = "supplied_by_default")'</a></code></pre></div>
<p>Try each of the following and look at the generated <code>Makefile</code> after each call to <code><a href="../reference/make.html">make()</a></code>. To see the recipes printed to the console, run <code><a href="../reference/clean.html">clean()</a></code> between each <code><a href="../reference/make.html">make()</a></code> and leave <code>verbose</code> equal to <code>TRUE</code> (default).</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">4</span>)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">  <span class="dt">recipe_command =</span> <span class="st">"Rscript -e"</span>)</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb27-5" data-line-number="5">  <span class="dt">recipe_command =</span> <span class="st">"Rscript -e 'R_RECIPE'"</span>)</a></code></pre></div>
<p>But do not try the following on Windows.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">  <span class="dt">recipe_command =</span> <span class="st">"R -e 'R_RECIPE' -q"</span>)</a>
<a class="sourceLine" id="cb28-3" data-line-number="3"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb28-4" data-line-number="4">  <span class="dt">recipe_command =</span> <span class="st">"R -q -e 'R_RECIPE'"</span>)</a>
<a class="sourceLine" id="cb28-5" data-line-number="5"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb28-6" data-line-number="6">  <span class="dt">recipe_command =</span> <span class="st">"R -q -e"</span>)</a></code></pre></div>
</div>
<div id="makefile-parallelism-on-a-cluster" class="section level3">
<h3 class="hasAnchor">
<a href="#makefile-parallelism-on-a-cluster" class="anchor"></a>Makefile parallelism on a cluster</h3>
<p>In the general case, you will need a new configuration file to tell the <code>Makefile</code> how to talk to the cluster. The <code><a href="../reference/shell_file.html">shell_file()</a></code> function writes a starter.</p>
<pre><code>#!/bin/bash
shift
echo "module load R; $*" | qsub -sync y -cwd -j y
</code></pre>
<p>This file acts as the “shell” for the <code>Makefile</code> instead of a typical <a href="https://www.gnu.org/software/bash">Unix shell</a>. It is a mechanism for tricking the <code>Makefile</code> into submitting each target as a job on a cluster rather than your local machine. You may need to configure <code>shell.sh</code> for your system, possibly changing <code>module load R</code> to point to the appropriate copy of R.</p>
<p>To tell the <code>Makefile</code> to use <code>shell.sh</code>, you add the line <code>SHELL=./shell.sh</code> to the top of the <code>Makefile</code> using the <code>prepend</code> argument to <code><a href="../reference/make.html">make()</a></code>.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">2</span>, <span class="dt">prepend =</span> <span class="st">"SHELL=./shell.sh"</span>)</a></code></pre></div>
<p><a href="https://slurm.schedmd.com/">SLURM</a> users may be able to <a href="http://plindenbaum.blogspot.com/2014/09/parallelizing-gnu-make-4-in-slurm.html">invoke <code>srun</code> and dispense with <code>shell.sh</code> altogether</a>, though success may vary depending on the SLURM system. You will probably also need to set resource allocation parameters governing memory, runtime, etc. See <code>man srun</code> for the possible <code>.SHELLFLAGS</code>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">  my_plan,</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">  <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>,</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">  <span class="dt">jobs =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb30-5" data-line-number="5">  <span class="dt">prepend =</span> <span class="kw">c</span>(</a>
<a class="sourceLine" id="cb30-6" data-line-number="6">    <span class="st">"SHELL=srun"</span>,</a>
<a class="sourceLine" id="cb30-7" data-line-number="7">    <span class="st">".SHELLFLAGS=-N1 -n1 bash -c"</span></a>
<a class="sourceLine" id="cb30-8" data-line-number="8">  )</a>
<a class="sourceLine" id="cb30-9" data-line-number="9">)</a></code></pre></div>
<p>In some cases, you may be able to use <code>recipe_command</code> to talk to the cluster rather than <code>prepend</code>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">parallelism =</span> <span class="st">"Makefile"</span>, <span class="dt">jobs =</span> <span class="dv">4</span>,</a>
<a class="sourceLine" id="cb31-2" data-line-number="2">  <span class="dt">recipe_command =</span> <span class="st">"tell_cluster_to_submit Rscript -e"</span>)</a></code></pre></div>
<p>Finally, to deploy your work, just save the call to <code><a href="../reference/make.html">make()</a></code> in an R script (say, <code>my_script.R</code>) and then launch it from the <a href="https://www.howtogeek.com/140679/beginner-geek-how-to-start-using-the-linux-terminal/">Linux terminal</a>.</p>
<pre><code>nohup nice -19 R CMD BATCH script.R &amp;
</code></pre>
</div>
</div>
</div>
<div id="drake-as-an-ordinary-job-scheduler" class="section level1">
<h1 class="hasAnchor">
<a href="#drake-as-an-ordinary-job-scheduler" class="anchor"></a>Drake as an ordinary job scheduler</h1>
<p>If you do not care about reproducibility and you want <code>drake</code> to be an ordinary job scheduler, consider using <a href="https://github.com/ropensci/drake/blob/master/vignettes/debug.Rmd#test-with-triggers">alternative triggers</a>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw"><a href="../reference/load_mtcars_example.html">load_mtcars_example</a></span>()</a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="kw"><a href="../reference/make.html">make</a></span>(my_plan, <span class="dt">trigger =</span> <span class="st">"missing"</span>) <span class="co"># Also consider "always".</span></a></code></pre></div>
<p>Above, <code>drake</code> only builds the missing targets. This skips much of the <a href="https://github.com/ropensci/drake/blob/master/vignettes/storage.Rmd#hash-algorithms">time-consuming hashing</a> that ordinarily detects which targets are out of date.</p>
</div>
<div id="final-thoughts" class="section level1">
<h1 class="hasAnchor">
<a href="#final-thoughts" class="anchor"></a>Final thoughts</h1>
<div id="debugging" class="section level2">
<h2 class="hasAnchor">
<a href="#debugging" class="anchor"></a>Debugging</h2>
<p>For large workflows, downsizing and debugging tools become super important. See the <a href="https://github.com/ropensci/drake/blob/master/vignettes/debug.Rmd">“debug” vignette</a> for help on diagnosing problems with a workflow. <a href="https://github.com/ropensci/drake/blob/master/vignettes/debug.Rmd#test-with-triggers">Triggers</a> and <a href="https://github.com/ropensci/drake/blob/master/vignettes/debug.Rmd#diagnose-failures">cached error logs</a> especially speed the development and testing process.</p>
</div>
<div id="zombies" class="section level2">
<h2 class="hasAnchor">
<a href="#zombies" class="anchor"></a>Zombies</h2>
<p>In versions of R prior to 3.5.0, some parallel backends, particularly <code>mclapply</code> and <code><a href="http://www.rdocumentation.org/packages/future/topics/multicore">future::multicore</a></code>, may create zombie processes. This issue is fixed in R versions 3.5.0 and later. Zombie children are not usually harmful, but you may wish to kill them yourself. The following function by <a href="https://github.com/CarlBoneri">Carl Boneri</a> should work on Unix-like systems. For a discussion, see <a href="https://github.com/ropensci/drake/issues/116">drake issue 116</a>.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">fork_kill_zombies &lt;-<span class="st"> </span><span class="cf">function</span>(){</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">  <span class="kw">require</span>(inline)</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">  includes &lt;-<span class="st"> "#include &lt;sys/wait.h&gt;"</span></a>
<a class="sourceLine" id="cb33-4" data-line-number="4">  code &lt;-<span class="st"> "int wstat; while (waitpid(-1, &amp;wstat, WNOHANG) &gt; 0) {};"</span></a>
<a class="sourceLine" id="cb33-5" data-line-number="5"></a>
<a class="sourceLine" id="cb33-6" data-line-number="6">  wait &lt;-<span class="st"> </span>inline<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/inline/topics/cfunction">cfunction</a></span>(</a>
<a class="sourceLine" id="cb33-7" data-line-number="7">    <span class="dt">body =</span> code,</a>
<a class="sourceLine" id="cb33-8" data-line-number="8">    <span class="dt">includes =</span> includes,</a>
<a class="sourceLine" id="cb33-9" data-line-number="9">    <span class="dt">convention =</span> <span class="st">".C"</span></a>
<a class="sourceLine" id="cb33-10" data-line-number="10">  )</a>
<a class="sourceLine" id="cb33-11" data-line-number="11"></a>
<a class="sourceLine" id="cb33-12" data-line-number="12">  <span class="kw">invisible</span>(<span class="kw">wait</span>())</a>
<a class="sourceLine" id="cb33-13" data-line-number="13">}</a></code></pre></div>
</div>
<div id="more-resources" class="section level2">
<h2 class="hasAnchor">
<a href="#more-resources" class="anchor"></a>More resources</h2>
<p>See the <a href="https://github.com/ropensci/drake/blob/master/vignettes/timing.Rmd">timing vignette</a> for explanations of functions <code><a href="../reference/rate_limiting_times.html">rate_limiting_times()</a></code> and <code><a href="../reference/predict_runtime.html">predict_runtime()</a></code>, which can help predict the possible speed gains of having multiple independent jobs. If you suspect <code>drake</code> itself is slowing down your project, you may want to read the storage vignette to learn how to set the hashing algorithms of your project.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#the-concept">The concept</a></li>
      <li>
<a href="#how-many-parallel-jobs-should-you-use">How many parallel jobs should you use?</a><ul class="nav nav-pills nav-stacked">
<li><a href="#not-too-many">Not too many!</a></li>
      <li><a href="#drake-can-report-the-maximum-number-of-useful-simultaneous-jobs">Drake can report the maximum number of useful simultaneous jobs</a></li>
      <li><a href="#caveats">Caveats</a></li>
      </ul>
</li>
      <li>
<a href="#parallel-backends">Parallel backends</a><ul class="nav nav-pills nav-stacked">
<li><a href="#mclapply">mclapply</a></li>
      <li><a href="#parlapply">parLapply</a></li>
      <li><a href="#future_lapply">future_lapply</a></li>
      <li><a href="#future">future</a></li>
      <li><a href="#makefile">Makefile</a></li>
      </ul>
</li>
      <li><a href="#drake-as-an-ordinary-job-scheduler">Drake as an ordinary job scheduler</a></li>
      <li>
<a href="#final-thoughts">Final thoughts</a><ul class="nav nav-pills nav-stacked">
<li><a href="#debugging">Debugging</a></li>
      <li><a href="#zombies">Zombies</a></li>
      <li><a href="#more-resources">More resources</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by William Michael Landau.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
